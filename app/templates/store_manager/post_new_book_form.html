<h1 class="text-center text-primary mb-5 mt-5">üì¶ NH·∫¨P TH√îNG TIN S√ÅCH M·ªöI</h1>
<div class="container">
    <form id="post_new_book" onsubmit="addBooks(event)">
        <div class="row gy-4" id="book-info-rows">
            <!-- Row 1 -->
            <div class="row gy-4 book-row" id="book_row_1">
                <div class="col-12">
                    <h5 class="fw-bold">S√°ch 1</h5>
                </div>
                <div class="col-md-6 col-lg-4">
                    <label for="name_1" class="form-label">T√™n s√°ch</label>
                    <input type="text" class="form-control" id="name_1" name="name_1"
                           placeholder="Nh·∫≠p t√™n s√°ch" required>
                </div>
                <div class="col-md-6 col-lg-4">
                    <label for="primary_genre_id_1" class="form-labe">Th·ªÉ lo·∫°i ch√≠nh</label>
                    <select class="form-select select2-enable" id="primary_genre_id_1"
                            onchange="handel_primary_genre_change(event)" name="primary_genre_id_1"
                            data-placeholder="Ch·ªçn th·ªÉ lo·∫°i ch√≠nh" required>
                        <option value="">Ch·ªçn th·ªÉ lo·∫°i ch√≠nh</option>
                        {% for genre in genres %}
                        <option value="{{ genre.id }}">{{ genre.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 col-lg-4">
                    <label for="image_1" class="form-label">H√ånh ·∫£nh ƒë·∫°i di·ªán</label>
                    <input type="file" class="form-control" id="image_1" name="image_1" placeholder="H√¨nh ·∫£nh ƒë·∫°i di·ªán"
                           accept="image/jpeg, image/png, image/gif" required>
                </div>
                <div class="col-md-6 col-lg-6">
                    <label for="genres_1" class="form-label">C√°c th·ªÉ lo·∫°i ph·ª•</label>
                    <select class="form-select select2-enable" id="genres_1" name="genres_1" multiple="multiple"
                            data-placeholder="Nh·∫≠p c√°c th·ªÉ lo·∫°i ph·ª•">
                        {% for genre in genres %}
                        <option value="{{ genre.id }}">{{ genre.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 col-lg-6">
                    <label for="authors_1" class="form-label">T√°c gi·∫£</label>
                    <select class="form-select select2-enable" id="authors_1" name="authors_1" multiple="multiple"
                            data-placeholder="Nh·∫≠p t√°c gi·∫£" required>
                        {% for author in authors %}
                        <option value="{{ author.id }}">{{ author.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 col-lg-4">
                    <label for="price_1" class="form-label">Gi√°</label>
                    <input type="number" class="form-control" id="price_1" name="price_1" placeholder="Gi√° s√°ch"
                           required>
                </div>
                <div class="col-md-6 col-lg-4">
                    <label for="pages_1" class="form-label">S·ªë trang</label>
                    <input type="number" class="form-control" id="pages_1" name="pages_1" placeholder="S·ªë trang" min="1"
                           required>
                </div>
                <div class="col-md-6 col-lg-4">
                    <label for="duration_1" class="form-label">Th·ªùi gian</label>
                    <input type="number" class="form-control" id="duration_1" name="duration_1" placeholder="Th·ªùi gian"
                           min="0" step="0.1" required>
                </div>
                <div class="col-md-12">
                    <label for="description_1" class="form-label">M√¥ t·∫£</label>
                    <textarea class="form-control" id="description_1" name="description_1" placeholder="Nh·∫≠p m√¥ t·∫£"
                              rows="3" required></textarea>
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteBookRow(this)">X√≥a s√°ch n√†y
                    </button>
                </div>
            </div>
        </div>

        <!-- N√∫t th√™m v√† submit -->
        <div class="row mt-4">
            <div class="col-12 d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" onclick="addBookRow()">‚ûï Th√™m s√°ch</button>
                <button type="submit" class="btn btn-primary">üì• X√°c nh·∫≠n nh·∫≠p th√¥ng tin s√°ch</button>
            </div>
        </div>
    </form>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script>
    let bookCount = 1;

    // H√†m th√™m s√°ch m·ªõi
    function addBookRow() {
        bookCount++;
        const bookRows = document.getElementById('book-info-rows');
        const newRow = `
    <div class="row gy-4 book-row" id="book_row_${bookCount}">
        <div class="col-12">
            <h5 class="fw-bold">S√°ch ${bookCount}</h5>
        </div>
        <div class="col-md-6 col-lg-4">
            <label for="name_${bookCount}" class="form-label">T√™n s√°ch</label>
            <input type="text" class="form-control" id="name_${bookCount}" name="name_${bookCount}" placeholder="Nh·∫≠p t√™n s√°ch" required>
        </div>
        <div class="col-md-6 col-lg-4">
            <label for="primary_genre_id_${bookCount}" class="form-label">Th·ªÉ lo·∫°i ch√≠nh</label>
            <select class="form-select select2-enable" id="primary_genre_id_${bookCount}" name="primary_genre_id_${bookCount}" onchange="handel_primary_genre_change(event)" data-placeholder="Ch·ªçn th·ªÉ lo·∫°i ch√≠nh" required>
                        <option value="">Ch·ªçn th·ªÉ lo·∫°i ch√≠nh</option>
                {% for genre in genres %}
                <option value="{{ genre.id }}">{{ genre.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 col-lg-4">
            <label for="image_${bookCount}" class="form-label">H√ånh ·∫£nh ƒë·∫°i di·ªán</label>
            <input type="file" class="form-control" id="image_${bookCount}" name="image_${bookCount}" placeholder="H√¨nh ·∫£nh ƒë·∫°i di·ªán"
                   accept="image/jpeg, image/png, image/gif" required>
        </div>
        <div class="col-md-6 col-lg-6">
            <label for="genres_${bookCount}" class="form-label">C√°c th·ªÉ lo·∫°i ph·ª•</label>
            <select class="form-select select2-enable" id="genres_${bookCount}" name="genres_${bookCount}" multiple="multiple" data-placeholder="Nh·∫≠p c√°c th·ªÉ lo·∫°i ph·ª•">
                {% for genre in genres %}
                <option value="{{ genre.id }}">{{ genre.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 col-lg-6">
            <label for="authors_${bookCount}" class="form-label">T√°c gi·∫£</label>
            <select class="form-select select2-enable" id="authors_${bookCount}" name="authors_${bookCount}" multiple="multiple" data-placeholder="Nh·∫≠p t√°c gi·∫£" required>
                {% for author in authors %}
                <option value="{{ author.id }}">{{ author.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 col-lg-4">
            <label for="price_${bookCount}" class="form-label">Gi√°</label>
            <input type="number" class="form-control" id="price_${bookCount}" name="price_${bookCount}" placeholder="Gi√° s√°ch" required>
        </div>
        <div class="col-md-6 col-lg-4">
            <label for="pages_${bookCount}" class="form-label">S·ªë trang</label>
            <input type="number" class="form-control" id="pages_${bookCount}" name="pages_${bookCount}" placeholder="S·ªë trang" min="1" required>
        </div>
        <div class="col-md-6 col-lg-4">
            <label for="duration_${bookCount}" class="form-label">Th·ªùi gian</label>
            <input type="number" class="form-control" id="duration_${bookCount}" name="duration_${bookCount}" placeholder="Th·ªùi gian" min="0" step="0.1" required>
        </div>
        <div class="col-md-12">
            <label for="description_${bookCount}" class="form-label">M√¥ t·∫£</label>
            <textarea class="form-control" id="description_${bookCount}" name="description_${bookCount}" placeholder="Nh·∫≠p m√¥ t·∫£" rows="3" required></textarea>
        </div>
        <div class="col-12 d-flex justify-content-end">
            <button type="button" class="btn btn-danger btn-sm" onclick="deleteBookRow(this)">X√≥a s√°ch n√†y</button>
        </div>
    </div>`;

        // Th√™m d√≤ng m·ªõi
        bookRows.insertAdjacentHTML('beforeend', newRow);

        // T√°i kh·ªüi t·∫°o select2 cho c√°c ph·∫ßn t·ª≠ m·ªõi
        $('#primary_genre_id_' + bookCount).select2({
            placeholder: "Ch·ªçn th·ªÉ lo·∫°i ch√≠nh",
            width: '100%',
            allowClear: true
        });

        $('#genres_' + bookCount).select2({
            placeholder: "Nh·∫≠p c√°c th·ªÉ lo·∫°i ph·ª•",
            width: '100%',
            allowClear: true
        });

        $('#authors_' + bookCount).select2({
            placeholder: "Nh·∫≠p t√°c gi·∫£",
            width: '100%',
            allowClear: true
        });
    }

    // H√†m x√≥a s√°ch
    function deleteBookRow(button) {
        const bookRow = button.closest('.book-row');
        if (bookRow) {
            bookRow.remove();
        }
    }

    // Kh·ªüi t·∫°o Select2
    function initSelect2() {
        $('.select2-enable').select2({
            placeholder: "Ch·ªçn m·ªôt m·ª•c",
            width: 'resolve',
            allowClear: true
        });
    }

    // Kh·ªüi ch·∫°y khi trang load
    $(document).ready(function () {
        initSelect2();
    });

    function addBooks(e) {
        e.preventDefault();

        // L·∫•y form
        const form = document.getElementById('post_new_book');
        const formData = new FormData();

        // M·∫£ng ch·ª©a th√¥ng tin s√°ch
        const booksData = [];

        // Duy·ªát qua t·∫•t c·∫£ c√°c input trong form v√† g·ªôp th√¥ng tin
        const rawFormData = new FormData(form);
        rawFormData.forEach((value, key) => {
            const keyParts = key.match(/(.+?)_(\d+)$/);
            if (keyParts) {
                const field = keyParts[1]; // T√™n tr∆∞·ªùng (book_name, primary_genre_id, genres, authors, ...)
                const index = parseInt(keyParts[2], 10) - 1; // Ch·ªâ s·ªë m·∫£ng (b·∫Øt ƒë·∫ßu t·ª´ 0)

                if (!booksData[index]) {
                    booksData[index] = {}; // T·∫°o object cho s√°ch n·∫øu ch∆∞a c√≥
                }

                // N·∫øu tr∆∞·ªùng l√† genres ho·∫∑c authors => lu√¥n ƒë·∫£m b·∫£o l√† m·∫£ng
                if (field === "genres" || field === "authors") {
                    if (!booksData[index][field]) {
                        booksData[index][field] = [];
                    }
                    booksData[index][field].push(value);
                } else if (field === "primary_genre_id") {
                    booksData[index][field] = value; // L∆∞u th·ªÉ lo·∫°i ch√≠nh
                } else if (field === "image") {
                    // ƒê√≠nh k√®m ·∫£nh tr·ª±c ti·∫øp v√†o FormData
                    formData.append(`images[${index}]`, value);
                } else {
                    booksData[index][field] = value; // L∆∞u c√°c tr∆∞·ªùng kh√°c nh∆∞ t√™n s√°ch, gi√°, m√¥ t·∫£, v.v.
                }
            }
        });

        // ƒê·∫£m b·∫£o genres v√† authors lu√¥n l√† m·∫£ng k·ªÉ c·∫£ khi c√≥ 1 ph·∫ßn t·ª≠
        booksData.forEach(book => {
            if (book.authors && !Array.isArray(book.authors)) {
                book.authors = [book.authors];
            }
            if (book.genres && !Array.isArray(book.genres)) {
                book.genres = [book.genres];
            }
        });

        // ƒê∆∞a d·ªØ li·ªáu s√°ch (tr·ª´ ·∫£nh) v√†o formData
        formData.append('books', JSON.stringify(booksData));

        // G·ª≠i d·ªØ li·ªáu l√™n server
        fetch('/store_manager/add_books', {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Kh√¥ng th·ªÉ g·ª≠i th√¥ng tin s√°ch!');
                }
            })
            .then(data => {
                alert(data.message);
                if (data.success){
                    location.reload()
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i th√¥ng tin s√°ch.');
            });
    }

    function handel_primary_genre_change(event) {
        const primaryGenreSelect = event.target;

        // L·∫•y ph·∫ßn t·ª≠ cha g·∫ßn nh·∫•t ch·ª©a primary_genre_id v√† genres
        const parentRow = primaryGenreSelect.closest('.row');

        // T√¨m 'select' c·ªßa th·ªÉ lo·∫°i ph·ª• g·∫ßn nh·∫•t trong ph·∫ßn t·ª≠ cha
        const genresSelect = parentRow.querySelector('select[name^="genres_"]');
        if (genresSelect) {
        const selectedPrimaryGenreId = primaryGenreSelect.value;

        $(genresSelect).find('option').each(function() {
            const option = $(this);
            if (option.val() === selectedPrimaryGenreId) {
                option.prop('disabled', true);  // V√¥ hi·ªáu h√≥a n·∫øu tr√πng v·ªõi th·ªÉ lo·∫°i ch√≠nh
            } else {
                option.prop('disabled', false); // K√≠ch ho·∫°t l·∫°i c√°c th·ªÉ lo·∫°i kh√°c
            }
        });

        // C·∫≠p nh·∫≠t l·∫°i Select2 ƒë·ªÉ ph·∫£n √°nh s·ª± thay ƒë·ªïi
        $(genresSelect).trigger('change');
    } else {
        console.error("Kh√¥ng t√¨m th·∫•y 'genres' g·∫ßn v·ªõi 'primary_genre_id'");
    }
    }

</script>
